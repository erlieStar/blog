(window.webpackJsonp=window.webpackJsonp||[]).push([[191],{588:function(s,a,t){"use strict";t.r(a);var n=t(56),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mybatis源码解析-动态代理让sql执行更安全高效"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mybatis源码解析-动态代理让sql执行更安全高效"}},[s._v("#")]),s._v(" Mybatis源码解析：动态代理让sql执行更安全高效")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/fedf9e0a01de460ca897ac7d9e75ad41.jpg?",alt:"请添加图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"mybatis为什么要使用动态代理对sqlsession进行增强"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mybatis为什么要使用动态代理对sqlsession进行增强"}},[s._v("#")]),s._v(" Mybatis为什么要使用动态代理对SqlSession进行增强？")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/aa8e8c46c59c479280d6bf115f87903f.png?",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("strong",[s._v("在ibatis时代，是直接通过sqlSession进行调用的")])]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSession")]),s._v(" sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("openSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfo")]),s._v(" userInfo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectOne")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"org.apache.ibatis.atest.UserInfoMapper.selectById"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("strong",[s._v("这种方式有什么缺点呢？")])]),s._v(" "),t("p",[s._v("调用的方法有可能写错，实际要执行的sql并没有配置\n传入的参数有可能写错，因为入参是Object类型\n返回值有可能写错，因为返回值也是Object类型")]),s._v(" "),t("p",[t("strong",[s._v("但是这些问题在编译的时候并不会暴露，只有在运行的时候才会暴露")])]),s._v(" "),t("p",[s._v("鉴于ibatis的这些问题，Mybatis使用了动态代理减少了错误的发生，并且让api变的更简洁易用")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSession")]),s._v(" sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("openSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfoMapper")]),s._v(" mapper "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfoMapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfo")]),s._v(" userInfo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mapper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectById")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("代理的主要流程如下图所示")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/5850364bbb1c4293955d878d5596884b.png?",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"创建代理对象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建代理对象"}},[s._v("#")]),s._v(" 创建代理对象")]),s._v(" "),t("p",[s._v("用上一节的例子来debug动态代理的过程，一步一步追")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSession")]),s._v(" sqlSession "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSessionFactory"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("openSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfoMapper")]),s._v(" mapper "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sqlSession"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfoMapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserInfo")]),s._v(" userInfo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mapper"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("selectById")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("之前的文章说过sqlSessionFactory的实现类是DefaultSqlSessionFactory，所以openSession返回的是DefaultSqlSession，追一下\nDefaultSqlSession#getMapper方法")]),s._v(" "),t("p",[s._v("org.apache.ibatis.session.defaults.DefaultSqlSession#getMapper\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/5d73ee2684b04a3caf64e8b414bd0f65.png",alt:"在这里插入图片描述"}}),s._v("\norg.apache.ibatis.session.Configuration#getMapper\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/a70953cfdaa247ee835df962bf76c641.png",alt:"在这里插入图片描述"}}),s._v("\norg.apache.ibatis.binding.MapperRegistry#getMapper\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/7793867ac12b434ea00090e4cada7a64.png?",alt:"在这里插入图片描述"}}),s._v("\norg.apache.ibatis.binding.MapperProxyFactory#newInstance(org.apache.ibatis.session.SqlSession)\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/9040a2e8fb2b437487dfb25ba6455fc3.png?",alt:"在这里插入图片描述"}}),s._v("\n整体逻辑并不复杂，利用MapperProxyFactory生成MapperProxy，而MapperProxy实现了InvocationHandler，所以返回的代理类就是MapperProxy，所以当执行Mapper接口的返回时，会首先进入MapperProxy#invoke方法")]),s._v(" "),t("p",[s._v("同时MapperProxy包装了SqlSession，从这我们就能猜到，后续MapperProxy肯定是利用调用的方法，拼装sql对应的id，然后交给SqlSession来执行查询")]),s._v(" "),t("h2",{attrs:{id:"执行动态代理方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行动态代理方法"}},[s._v("#")]),s._v(" 执行动态代理方法")]),s._v(" "),t("p",[s._v("当执行Mapper接口的任何方法时，都会进入MapperProxy#invoke方法（MapperProxy实现了InvocationHandler接口）")]),s._v(" "),t("p",[s._v("org.apache.ibatis.binding.MapperProxy#invoke\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/b9732dfdf3d440fcb5a7ef770b9358ca.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("如果执行的是Object类中的方法，直接反射执行即可，否则执行cachedInvoker方法得到MapperMethodInvoker，然后调用其invoke方法")]),s._v(" "),t("p",[s._v("org.apache.ibatis.binding.MapperProxy#cachedInvoker\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/e4119ef695be486caa5135bd75d20c0f.png?",alt:"在这里插入图片描述"}}),s._v("\norg.apache.ibatis.util.MapUtil#computeIfAbsent\n"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/ad10260249424df08fccc2fbd4e1c4d6.png?",alt:"在这里插入图片描述"}}),s._v(" "),t("strong",[s._v("把要执行的方法封装为MapperMethodInvoker，并通过ConcurrentHashMap缓存下来，MapUtil#computeIfAbsent就是一个简单的工具类，利用computeIfAbsent来保证线程安全")])]),s._v(" "),t("p",[s._v("如果是接口的默认方法则封装为DefaultMethodInvoker\n否则封装为PlainMethodInvoker（一般情况，我们都不会对接口提供default方法，所以我们看一下PlainMethodInvoker#invoke的逻辑）")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/fa6332ff72784f7b9f23672a5b59d4e2.png?",alt:"在这里插入图片描述"}}),s._v("\n调用MapperMethod#execute方法，和我们之前分享的参数处理器和SqlSession的执行流程接上了哈，至此整个执行流程分析完毕")])])}),[],!1,null,null,null);a.default=e.exports}}]);