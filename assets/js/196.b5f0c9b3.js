(window.webpackJsonp=window.webpackJsonp||[]).push([[196],{595:function(s,t,a){"use strict";a.r(t);var r=a(56),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql实战-buffer-pool-提高页的访问速度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql实战-buffer-pool-提高页的访问速度"}},[s._v("#")]),s._v(" MySQL实战：Buffer Pool 提高页的访问速度")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/c681e9f75b5f48e280b5fc59fbfb7362.png",alt:"请添加图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"如何提高sql执行速度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何提高sql执行速度"}},[s._v("#")]),s._v(" 如何提高SQL执行速度？")]),s._v(" "),a("p",[a("strong",[s._v("当我们想更新某条数据的时候，难道是从磁盘中加载出来这条数据，更新后再持久化到磁盘中吗？")])]),s._v(" "),a("p",[s._v("如果这样搞的话，那一条sql的执行过程可太慢了，因为对一个大磁盘文件的读写操作是要耗费几百万毫秒的")]),s._v(" "),a("p",[s._v("真实的执行过程是，当我们想更新或者读取某条数据的时候，会把对应的页加载到Buffer Pool缓冲池中（Buffer Pool本质上就是一块连续的内存空间）")]),s._v(" "),a("p",[a("strong",[s._v("默认为128m，当然为了提高系统的并发度，你可以把这个值设大一点")]),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/direct/cb3cc03d43cb49578d3e4d39d2652b0e.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("之所以加载页到Buffer Pool中，是考虑到当你使用这个页的数据时，这个页的其他数据使用到的概率页很大，随机IO的耗时很长，所以多加载一点数据到Buffer Pool")]),s._v(" "),a("p",[a("strong",[s._v("Buffer Pool的数据结构是怎样的？")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/8764d82e1196434c84a910d1c0b04d9f.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("Buffer Pool中主要分为2部分，缓存页和描述数据，MySQL从磁盘加载的数据页会放入缓存页中")]),s._v(" "),a("p",[s._v("对于每个缓存页都有对应的描述信息，比如数据页所属于表空间，数据页的编号等")]),s._v(" "),a("p",[s._v("Buffer Pool中的描述数据大概相当于缓存页大小的5%左右，这部分内存是不包含在Buffer Pool中的")]),s._v(" "),a("p",[s._v("当更新数据的时候，如果对应的页在Buffer Pool中，则直接更新Buffer Pool中的页即可，对应的页不在Buffer Pool中时，才会从磁盘加载对应的页到Buffer Pool，然后再更新，"),a("strong",[s._v("此时Buffer Pool中的页和磁盘中的页数据是不一致的，被称为脏页")]),s._v("。这些脏页是要被刷回到磁盘中的")]),s._v(" "),a("p",[a("strong",[s._v("这些脏页是多会刷回到磁盘中的？")]),s._v(" 有如下几个时机")]),s._v(" "),a("ol",[a("li",[s._v("Buffer Pool不够用了，要给新加载的页腾位置了，所以会利用改进的后的LRU算法，将一些脏页刷回磁盘")]),s._v(" "),a("li",[s._v("后台线程会在MySQL不繁忙的时候，将脏页刷到磁盘中")]),s._v(" "),a("li",[s._v("redolog写满时（redolog的作用后面会提到）")]),s._v(" "),a("li",[s._v("数据库关闭时会将所有脏页刷回到磁盘")])]),s._v(" "),a("p",[s._v("这样搞，效率是不是高很多了？")]),s._v(" "),a("p",[s._v("当需要更新的数据所在的页已经在Buffer Pool中时，只需要操作内存即可，效率不是一般的高")]),s._v(" "),a("p",[a("strong",[s._v("我们怎么知道哪些缓存页是空闲的？")])]),s._v(" "),a("p",[s._v("MySQL为Buffer Pool设计了一个free链表，它是一个双向链表，每个节点就是一个空闲缓存页的描述数据")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/83ebd89921b9490683abfde81c403519.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("我们如何知道缓存页是否被加载到内存了？")])]),s._v(" "),a("p",[s._v("很简单啊，建立一个哈希表不就行了，key为表空间号+页号，value为对应的缓存页")]),s._v(" "),a("p",[s._v("当把数据页读取到缓存页的时候，对应的描述数据会从free链表放到flush链表")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/796dc91b34cf47b098772416d2e9c870.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("当不停的把磁盘上的数据页加载到缓存页，free链表不停的移除空闲缓存页，当free链表上没有空闲缓存页，当你还要加载数据页到缓存页时，该怎么办呢？")]),s._v(" "),a("p",[a("strong",[s._v("如果要淘汰一些数据，该淘汰谁呢？")])]),s._v(" "),a("p",[a("strong",[s._v("引入LRU链表来判断哪些缓存页是不常用的？")])]),s._v(" "),a("p",[s._v("缓存淘汰策略在很多中间件中会被用到，其中用的最多的就是LRU算法，当每访问一个缓存页的时候就把缓存页移到链表的头部")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/c0ea8e61b9794413ad2a4312657f0f61.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("我们只需要把链表尾部的缓存页刷到内存中，然后加载新的数据页即可。")]),s._v(" "),a("p",[a("strong",[s._v("这样的方式看似很完美，但是在实际运行过程中会存在巨大的隐患")])]),s._v(" "),a("p",[s._v("首先就是mysql的预读，")]),s._v(" "),a("p",[s._v("哪些情况会触发MySQL的预读")]),s._v(" "),a("p",[s._v("当发生全表扫描的时候（比如 select * from users），会导致表里的数据页都加载到 Buffer Pool 中去。这样有可能导致LRU链表前面一大串数据页都是全表扫描加载进来的数据页，但是如果这次全表扫描过后后续几乎没用到这个表里面的数据呢？")]),s._v(" "),a("p",[s._v("这样就会导致经常被扫描的缓存页被淘汰了，留下的都是全表扫描加载进来的缓存页")]),s._v(" "),a("p",[a("strong",[s._v("为了解决这个问题，LRU链表改进了一下，采用了冷热分离的思想。")])]),s._v(" "),a("p",[s._v("即LRU链表会被拆分为2部分，一部分是冷数据，一部分是热数据")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/b2042c628ae144ee8c7828fb2109446e.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("冷热数据的比例由innodb_old_blocks_pct参数控制")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_old_blocks_pct'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Variable_name         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Value")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" innodb_old_blocks_pct "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-----------------------+-------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.02")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[a("strong",[s._v("改进后的链表是如何工作的？")])]),s._v(" "),a("p",[s._v("当数据页第一次被加载到缓存的时候，缓存页会被放到冷数据区域的链表头部。")]),s._v(" "),a("p",[s._v("那么冷数据区的缓存页多会放到热数据区呢？")]),s._v(" "),a("p",[s._v("当一个数据页被加载到缓存页后，在1s（innodb_old_blocks_time参数控制）之后，再次访问这个缓存页，会被挪动到热数据区域的链表头部去")]),s._v(" "),a("p",[s._v("当多线程访问Buffer Pool中的各种链表时，需要加锁保证线程安全，影响请求的处理速度，此时我们就可以将Buffer Pool分为多个，多线程访问时不会互相影响，提高了请求的处理速度\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/797538f21bc74d8caadf8147aff2ce2d.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("在MySQL 5.7.5之前，Buffer Pool不能动态扩展。为了增加动态扩展就增加了chunk机制，有兴趣的小伙伴可以看看其他资料，就不多做分析了")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/30af48c49364408480b6243c294f1291.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"buffer-pool的相关参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#buffer-pool的相关参数"}},[s._v("#")]),s._v(" Buffer Pool的相关参数")]),s._v(" "),a("p",[s._v("学习了这么多理论知识，那么Buffer Pool应该调多大呢？")]),s._v(" "),a("p",[s._v("执行如下命令可以得到Buffer Pool的大小，名字，以及chunk的大小")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%innodb_buffer%'")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/64daa56e82bd4bfb87f5882fa6094052.png",alt:"在这里插入图片描述"}}),s._v("\ninnodb_buffer_pool_size的单位是字节，我们转成MB来看一下，默认是128M")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 128m")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" @"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@innodb_buffer_pool_size")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\n")])])]),a("p",[s._v("执行如下命令可以得到buffer_pool的当前使用状态")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%buffer_pool%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/65ad9105822842bfade6b5b849c7fc8e.png",alt:"在这里插入图片描述"}}),s._v(" "),a("strong",[s._v("我们挑一些重要的参数来分析一下")])]),s._v(" "),a("p",[s._v("Innodb_buffer_pool_read_requests：读的请求次数")]),s._v(" "),a("p",[s._v("Innodb_buffer_pool_reads：从物理磁盘中读取数据的次数")]),s._v(" "),a("p",[s._v("Innodb_buffer_pool_pages_data：有数据的缓存页")]),s._v(" "),a("p",[s._v("Innodb_buffer_pool_pages_free：空闲缓存页")]),s._v(" "),a("p",[s._v("Innodb_buffer_pool_pages_total：总共的缓存页")]),s._v(" "),a("hr"),s._v("\nBuffer Pool 读缓存命中率：\n"),a("p",[s._v("(Innodb_buffer_pool_read_requests - Innodb_buffer_pool_reads) / （Innodb_buffer_pool_read_requests） *100%")]),s._v(" "),a("hr"),s._v("\nBuffer Pool 脏页比率：\n"),a("p",[s._v("Innodb_buffer_pool_pages_dirty / （Innodb_buffer_pool_pages_data）*100%")]),s._v(" "),a("hr"),s._v("\nBuffer Pool 使用率：\n"),a("p",[s._v("innodb_buffer_pool_pages_data / ( innodb_buffer_pool_pages_data + innodb_buffer_pool_pages_free ) * 100%")]),s._v(" "),a("p",[a("strong",[s._v("缓存命中率比较低可以增大Buffer Pool的大小")])]),s._v(" "),a("p",[a("strong",[s._v("使用率比较高时可以增大Buffer Pool的大小")])]),s._v(" "),a("p",[s._v("你也可以执行如下命令获取一些关于Buffer Pool的其他参数，本篇文章就不多做介绍了")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);