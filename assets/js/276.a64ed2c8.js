(window.webpackJsonp=window.webpackJsonp||[]).push([[276],{673:function(t,a,n){"use strict";n.r(a);var s=n(56),e=Object(s.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"spring-ioc源码解析-spring容器启动流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring-ioc源码解析-spring容器启动流程"}},[t._v("#")]),t._v(" Spring IOC源码解析：Spring容器启动流程")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/39a8e3a839458f1e2843d827b9c186ac.jpeg",alt:"在这里插入图片描述"}})]),t._v(" "),n("h2",{attrs:{id:"基本概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本概念"}},[t._v("#")]),t._v(" 基本概念")]),t._v(" "),n("p",[t._v("本篇文章是我们Spring源码专栏的第一篇，这个专栏我不会分享那些比较基础的知识点，比如ioc aop的好处之类的，这些内容写的人也比较多，你可以看一下其他博主的文章，这个专栏我会尽量挑干货来分享")]),t._v(" "),n("p",[n("strong",[t._v("Spring是一个IOC容器")]),t._v("\n当我们不用Spring进行开发时，我们需要在代码中设置对象的依赖关系。当我们用了Spring之后，由Spring来管理这种依赖关系，当我们想使用对象时，直接从Spring容器中获取即可")]),t._v(" "),n("p",[n("strong",[t._v("BeanDefinition")]),t._v("\n在Spring中对象被叫做Bean，因为Spring Bean在Java类的基础上增加了很多概念，比如scope（作用域），isLazyInit（是否延迟初始化），isSingleton（是否单例），此时Java类不能完整的描述，所以需要新的定义描述类，这个类就是BeanDefinition")]),t._v(" "),n("p",[n("strong",[t._v("BeanDefinitionReader")]),t._v("\nBeanDefinitionReader会将配置的bean解析成为BeanDefinition，Spring Bean的配置方式有很多种，如XML，properties，groovy，注解（可能通过properties，groovy的方式你不常用，但Spring确实支持这种方式），所以BeanDefinitionReader的实现类也很多")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/bf324e9e2997840b19a17c04ccac8fb6.png",alt:"在这里插入图片描述"}})]),t._v(" "),n("p",[n("strong",[t._v("ClassPathBeanDefinitionScanner")]),t._v("\n当把Bean配置出后，得需要相应的组件把他们从资源文件中扫描出来，这个组件就是ClassPathBeanDefinitionScanner")]),t._v(" "),n("p",[n("strong",[t._v("BeanDefinitionRegistry")]),t._v("\nBeanDefinitionReader将配置的bean解析成为BeanDefinition，需要将BeanDefinition保存到BeanDefinitionRegistry。类似工厂把原料保存到仓库中，供后续生产产品使用")]),t._v(" "),n("p",[n("strong",[t._v("BeanFactory")]),t._v("\nBeanFactory会根据BeanDefinition将Bean生产出来")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/dadab632e9d4de96c61043ec2f7dd967.png",alt:"在这里插入图片描述"}}),t._v("\n一些比较重要的BeanFactory如图所示。"),n("strong",[t._v("可能你比较纳闷，为什么有的容器的类名后缀为BeanFactory，有的则为ApplicationContext？")]),t._v(" 这其实是一个很常见的面试")]),t._v(" "),n("ol",[n("li",[t._v("BeanFactory是一个最基础的IOC容器，提供了依赖查找，依赖注入等基础的功能")]),t._v(" "),n("li",[t._v("ApplicationContext继承了BeanFactory，在BeanFactory的基础上增加了企业级的功能，如AOP，资源管理（Resources）事件（Event），国际化（i18n），Environment抽象等")])]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/25480ad125ca13ba251b93c31d7d40a8.png",alt:"在这里插入图片描述"}}),t._v("\n从接口的定义上你就可以看出来，我们一般在开发的时候也都是用ApplicationContext，而且大多继承自GenericApplicationContext")]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/cf1331ede383c50fa16f10f820c1d378.png",alt:"在这里插入图片描述"}}),t._v(" "),n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/d832b7cf5c02b3794dbc18f83e13c2f2.png",alt:"在这里插入图片描述"}}),t._v(" "),n("strong",[t._v("GenericApplicationContext本身就是一个BeanFactory，但是它却把对Bean的一些基本操作委托给DefaultListableBeanFactory，典型的代理模式")])]),t._v(" "),n("p",[t._v("因为GenericApplicationContext是最常用的ApplicationContext，它将对Bean的基本操作委托给DefaultListableBeanFactory，所以在大部分应用下对Bean的操作都是由DefaultListableBeanFactory来完成的")]),t._v(" "),n("p",[n("strong",[t._v("DefaultListableBeanFactory")])]),t._v(" "),n("p",[t._v("DefaultListableBeanFactory同时实现了BeanDefinitionRegistry接口和BeanFactory接口，所以能保存BeanDefinition，同时又能根据BeanDefinition将Bean生产出来")]),t._v(" "),n("p",[n("strong",[t._v("BeanPostProcessor")]),t._v("\nBeanFactory根据BeanDefinition生成Bean的过程是一个标准化的流程，就像一个流水线一样，当然你可以在这个流水线上做一些自定义的操作。"),n("strong",[t._v("在Spring中你可以通过实现BeanPostProcessor来干预Bean的生产过程")])]),t._v(" "),n("p",[n("strong",[t._v("BeanFactoryPostProcessor")]),t._v("\nSpring作为一个强大的容器，不仅能让你干预Bean的生产过程，还可以让你干预BeanFactory，"),n("strong",[t._v("例如你可以通过BeanFactoryPostProcessor将Bean的作用域都改成原型，默认是单例")])]),t._v(" "),n("p",[n("strong",[t._v("所以BeanPostProcessor和BeanFactoryPostProcessor是spring容器2个很重要的扩展点，大多数框架和Spring框架继承基本上都是基于这2个扩展点来的")])]),t._v(" "),n("h2",{attrs:{id:"容器初始化过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#容器初始化过程"}},[t._v("#")]),t._v(" 容器初始化过程")]),t._v(" "),n("p",[t._v("我们常用的容器有如下2种")]),t._v(" "),n("ol",[n("li",[t._v("基于xml配置Bean（ClassPathXmlApplicationContext）")]),t._v(" "),n("li",[t._v("基于注解配置Bean（AnnotationConfigApplicationContext）")])]),t._v(" "),n("p",[t._v("因为我们现在开发都是基于注解，所以分析一下AnnotationConfigApplicationContext的启动流程")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Repository")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDao")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@ComponentScan")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"com.javashitang"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppConfig")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Main")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 容器启动完毕")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AnnotationConfigApplicationContext")]),t._v(" context "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AnnotationConfigApplicationContext")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppConfig")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDao")]),t._v(" userDao "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDao")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" str "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" userDao"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("可以看到当AnnotationConfigApplicationContext被new出来的时候，容器已经启动完毕，后续就可以直接从容器中获取Bean了。")]),t._v(" "),n("p",[t._v("构造函数主要执行了如下3个步骤，其中this和register方法主要是容器初始化的过程。refresh是刷新容器，即启动的过程，在这个里面做了很多操作，我们后面会用一个小节来分析\n"),n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/005f7004fbfc7ecfa0872412f3c12c30.png",alt:"在这里插入图片描述"}})]),t._v(" "),n("p",[n("strong",[t._v("需要注意的一点是，在容器初始化的过程中注册了6个Bean")])]),t._v(" "),n("ol",[n("li",[t._v("ConfigurationClassPostProcessor（"),n("strong",[t._v("实现了BeanFactoryPostProcessor，处理@Configuration，@ComponmentScan等注解，这是一个很重要的类")]),t._v("）")]),t._v(" "),n("li",[n("strong",[t._v("AutowiredAnnotationBeanPostProcessor（实现了BeanPostProcessor，处理@Autowired，@Value等）")])]),t._v(" "),n("li",[n("strong",[t._v("CommonAnnotationBeanPostProcessor（实现了BeanPostProcessor，用来处理JSR-250规范的注解，如@Resource，@PostConstruct等）")])]),t._v(" "),n("li",[t._v("PersistenceAnnotationBeanPostProcessor（实现了BeanFactoryPostProcessor，用来支持JPA，在我们这个Demo中不会注册，因为路径中没有JPA相关的类）")]),t._v(" "),n("li",[t._v("EventListenerMethodProcessor（实现了BeanFactoryPostProcessor）")]),t._v(" "),n("li",[t._v("DefaultEventListenerFactory")])]),t._v(" "),n("p",[t._v("注册的过程估计你也猜到了，就是将对应的类，如ConfigurationClassPostProcessor解析为RootBeanDefinition，并注册到BeanDefinitionRegistry中")]),t._v(" "),n("p",[n("strong",[t._v("这几个BeanPostProcessor在Spring Bean的生命周期中发挥了很大的作用，我们在Spring Bean生命周期这篇文章中来分析")]),t._v("。")]),t._v(" "),n("p",[t._v("好了，我们来看最重要的过程，容器刷新的过程，入口方法为AbstractApplicationContext#refresh")]),t._v(" "),n("p",[n("strong",[t._v("AbstractApplicationContext是一个很重要的类，基本上所有的ApplicationContext都继承自AbstractApplicationContext")])]),t._v(" "),n("h2",{attrs:{id:"容器刷新过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#容器刷新过程"}},[t._v("#")]),t._v(" 容器刷新过程")]),t._v(" "),n("p",[n("strong",[t._v("容器刷新的过程可以细分为如下几个步骤")])]),t._v(" "),n("ol",[n("li",[t._v("Spring应用上下文启动准备阶段")]),t._v(" "),n("li",[t._v("BeanFactory创建阶段")]),t._v(" "),n("li",[t._v("BeanFactory准备阶段")]),t._v(" "),n("li",[t._v("BeanFactory后置处理阶段")]),t._v(" "),n("li",[t._v("BeanFactory注册BeanPostProcessor阶段")]),t._v(" "),n("li",[t._v("初始化内建Bean：MessageSource")]),t._v(" "),n("li",[t._v("初始化内建Bean：Spring事件广播器")]),t._v(" "),n("li",[t._v("Spring应用上下文刷新阶段")]),t._v(" "),n("li",[t._v("Spring事件监听器注册阶段")]),t._v(" "),n("li",[t._v("BeanFactory初始化完成阶段")]),t._v(" "),n("li",[t._v("Spring应用上下文启动完成阶段")])]),t._v(" "),n("p",[n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/fb36bc755a3c1a5e79b27476a421e3cc.png",alt:"在这里插入图片描述"}})]),t._v(" "),n("h2",{attrs:{id:"spring应用上下文启动准备阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring应用上下文启动准备阶段"}},[t._v("#")]),t._v(" Spring应用上下文启动准备阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#prepareRefresh")]),t._v(" "),n("ol",[n("li",[t._v("记录启动时间 startupDate")]),t._v(" "),n("li",[t._v("设置标志为closed（false），active（true）")]),t._v(" "),n("li",[t._v("初始化PropertySources")]),t._v(" "),n("li",[t._v("校验Environment中必须属性")]),t._v(" "),n("li",[t._v("初始化事件监听器集合")]),t._v(" "),n("li",[t._v("初始化早期Spring事件集合")])]),t._v(" "),n("h2",{attrs:{id:"beanfactory创建阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#beanfactory创建阶段"}},[t._v("#")]),t._v(" BeanFactory创建阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#obtainFreshBeanFactory")]),t._v(" "),n("p",[t._v("刷新Spring应用上下文底层BeanFactory（refreshBeanFactory）")]),t._v(" "),n("ol",[n("li",[t._v("如果已存在BeanFactory，销毁Bean，并且关闭BeanFactory")]),t._v(" "),n("li",[t._v("创建DefaultListableBeanFactory（一般情况下都是DefaultListableBeanFactory）")]),t._v(" "),n("li",[t._v("设置BeanFactory id")]),t._v(" "),n("li",[t._v("设置BeanFactory是否允许BeanDefinition重复定义，是否允许循环引用")]),t._v(" "),n("li",[t._v("加载BeanDefinition")]),t._v(" "),n("li",[t._v("关联新建的BeanFactory到Spring应用上下文")])]),t._v(" "),n("p",[t._v("返回Spring应用上下文底层BeanFactory（getBeanFactory）")]),t._v(" "),n("h2",{attrs:{id:"beanfactory准备阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#beanfactory准备阶段"}},[t._v("#")]),t._v(" BeanFactory准备阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#prepareBeanFactory")]),t._v(" "),n("ol",[n("li",[t._v("关联ClassLoader")]),t._v(" "),n("li",[t._v("设置Bean表达式处理器")]),t._v(" "),n("li",[t._v("添加 PropertyEditorRegistrar 的实现 ResourceEditorRegistrar")]),t._v(" "),n("li",[n("strong",[t._v("注册BeanPostProcessor（ApplicationContextAwareProcessor）")]),t._v("，用来处理Aware回调接口")]),t._v(" "),n("li",[t._v("忽略Aware回调接口作为依赖注入接口")]),t._v(" "),n("li",[t._v("注册ResolvableDependency对象-BeanFactory，ResourceLoader，ApplicationEventPublisher，ApplicationContext")]),t._v(" "),n("li",[n("strong",[t._v("注册BeanPostProcessor（ApplicationListenerDetector）")]),t._v("，用来处理ApplicationListener接口")]),t._v(" "),n("li",[t._v("注册BeanPostProcessor（LoadTimeWeaverAwareProcessor），用来处理aop")]),t._v(" "),n("li",[t._v("注册单例对象（Environment，Java System Properties以及OS环境变量）")])]),t._v(" "),n("h2",{attrs:{id:"beanfactory后置处理阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#beanfactory后置处理阶段"}},[t._v("#")]),t._v(" BeanFactory后置处理阶段")]),t._v(" "),n("p",[t._v("如果想对BeanFactory进行扩展，可以通过如下2种方式")]),t._v(" "),n("ol",[n("li",[t._v("子类重写AbstractApplicationContext#postProcessBeanFactory方法")]),t._v(" "),n("li",[t._v("实现BeanFactoryPostProcessor接口")])]),t._v(" "),n("p",[t._v("AbstractApplicationContext#invokeBeanFactoryPostProcessors\n方法就是用来处理BeanFactoryPostProcessor接口的，调用的次序比较复杂，总结如下")]),t._v(" "),n("ol",[n("li",[t._v("BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry（入参中的）")]),t._v(" "),n("li",[t._v("BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry（容器中的，并且实现了PriorityOrdered接口）")]),t._v(" "),n("li",[t._v("BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry（容器中的，并且实现了Ordered接口）")]),t._v(" "),n("li",[t._v("BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry（容器中的，除去第2，3步剩余的BeanDefinitionRegistryPostProcessor）")]),t._v(" "),n("li",[t._v("BeanDefinitionRegistryPostProcessor#postProcessBeanFactory（所有BeanDefinitionRegistryPostProcessor接口实现类）")]),t._v(" "),n("li",[t._v("BeanFactoryPostProcessor#postProcessBeanFactory（入参数中的）")]),t._v(" "),n("li",[t._v("BeanFactoryPostProcessor#postProcessBeanFactory（容器中的，实现了PriorityOrdered接口）")]),t._v(" "),n("li",[t._v("BeanFactoryPostProcessor#postProcessBeanFactory（容器中的，实现了Ordered接口）")]),t._v(" "),n("li",[t._v("BeanFactoryPostProcessor#postProcessBeanFactory（容器中的，除去7，8步剩余的BeanFactoryPostProcessor）")])]),t._v(" "),n("p",[n("strong",[t._v("注册BeanPostProcessor（ConfigurationClassPostProcessor.ImportAwareBeanPostProcessor）")])]),t._v(" "),n("p",[t._v("注册LoadTimeWeaverAwareProcessor对象")]),t._v(" "),n("p",[t._v("前面说过在容器初始化的过程中，往容器中注入了一个BeanFactoryPostProcessor接口的实现类即ConfigurationClassPostProcessor。")]),t._v(" "),n("p",[n("strong",[t._v("这是一个非常重要的BeanFactoryPostProcessor，通过@Bean、@Component、@ComponentScan、@Import、@ImportResource注入Bean的方式都由这个类来处理，对这些注解的实现感兴趣的小伙伴可以看一下这个类的源码")])]),t._v(" "),n("h2",{attrs:{id:"beanfactory注册beanpostprocessor阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#beanfactory注册beanpostprocessor阶段"}},[t._v("#")]),t._v(" BeanFactory注册BeanPostProcessor阶段")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("注册BeanPostProcessor（PostProcessorRegistrationDelegate.BeanPostProcessorChecker）")])]),t._v(" "),n("li",[t._v("注册PriorityOrdered类型的BeanPostProcessor")]),t._v(" "),n("li",[t._v("注册Ordered类型的BeanPostProcessor")]),t._v(" "),n("li",[t._v("注册普通的BeanPostProcessor")]),t._v(" "),n("li",[t._v("注册MergedBeanDefinitionPostProcessor")]),t._v(" "),n("li",[n("strong",[t._v("注册BeanPostProcessor（ApplicationListenerDetector）")])])]),t._v(" "),n("p",[n("strong",[t._v("此时注册到容器中的BeanPostProcessor有如下6个（注册的时机我都在前文标注过了）")]),t._v("，这6个BeanPostProcessor在Spring Bean的生命周期中起着重要的作用\n"),n("img",{attrs:{src:"https://i-blog.csdnimg.cn/blog_migrate/99c1cbc8a80e175c78c29159464ddb87.png",alt:"在这里插入图片描述"}})]),t._v(" "),n("h2",{attrs:{id:"初始化内建bean-messagesource"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化内建bean-messagesource"}},[t._v("#")]),t._v(" 初始化内建Bean：MessageSource")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#initMessageSource\n国际化相关的内容，不怎么用，不研究了")]),t._v(" "),n("h2",{attrs:{id:"初始化内建bean-spring事件广播器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化内建bean-spring事件广播器"}},[t._v("#")]),t._v(" 初始化内建Bean：Spring事件广播器")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#initApplicationEventMulticaster")]),t._v(" "),n("h2",{attrs:{id:"spring应用上下文刷新阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring应用上下文刷新阶段"}},[t._v("#")]),t._v(" Spring应用上下文刷新阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#onRefresh\n留给子类扩展用的")]),t._v(" "),n("h2",{attrs:{id:"spring事件监听器注册阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring事件监听器注册阶段"}},[t._v("#")]),t._v(" Spring事件监听器注册阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#registerListeners")]),t._v(" "),n("ol",[n("li",[t._v("添加当前应用上下文所关联的ApplicationListener对象")]),t._v(" "),n("li",[t._v("添加BeanFactory所注册的ApplicationListener")]),t._v(" "),n("li",[t._v("广播早期Spring事件")])]),t._v(" "),n("h2",{attrs:{id:"beanfactory初始化完成阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#beanfactory初始化完成阶段"}},[t._v("#")]),t._v(" BeanFactory初始化完成阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#finishBeanFactoryInitialization")]),t._v(" "),n("ol",[n("li",[t._v("conversionService如果存在的话，设置到beanFactory")]),t._v(" "),n("li",[t._v("添加 StringValueResolver 对象")]),t._v(" "),n("li",[t._v("依赖查找LoadTimeWeaverAware Bean")]),t._v(" "),n("li",[t._v("beanFactory将ClassLoader临时设置为null")]),t._v(" "),n("li",[t._v("beanFactory冻结配置")]),t._v(" "),n("li",[t._v("beanFactory初始化非延迟单例Beans")])]),t._v(" "),n("p",[n("strong",[t._v("说一个高频面试题，Spring容器在何时创建对象？")])]),t._v(" "),n("ol",[n("li",[t._v("scope=singleton，容器启动过程中创建对象")]),t._v(" "),n("li",[t._v('scope!=singleton，延迟Bean（加了@Lazy，或<bean lazy-init="true"/>），在调用getBean的同时创建对象')])]),t._v(" "),n("h2",{attrs:{id:"spring应用上下文启动完成阶段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring应用上下文启动完成阶段"}},[t._v("#")]),t._v(" Spring应用上下文启动完成阶段")]),t._v(" "),n("p",[t._v("AbstractApplicationContext#finishRefresh")]),t._v(" "),n("ol",[n("li",[t._v("清除ResoureLoader缓存")]),t._v(" "),n("li",[t._v("初始化lifecycleProcessor对象")]),t._v(" "),n("li",[t._v("调用lifecycleProcessor#onRefresh方法")]),t._v(" "),n("li",[t._v("发布应用上下文刷新事件 ContextRefreshedEvent")]),t._v(" "),n("li",[t._v("向MBeanServer托管Live Beans")])])])}),[],!1,null,null,null);a.default=e.exports}}]);