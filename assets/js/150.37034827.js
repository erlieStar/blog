(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{548:function(t,a,s){"use strict";s.r(a);var e=s(56),v=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"面试官-脏读-不可重复读-幻读是如何发生的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#面试官-脏读-不可重复读-幻读是如何发生的"}},[t._v("#")]),t._v(" 面试官：脏读，不可重复读，幻读是如何发生的？")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20201201221503554.jpg?",alt:"在这里插入图片描述"}})]),t._v(" "),s("h2",{attrs:{id:"介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),s("p",[t._v("要聊事务，不可避免的要提到数据库事务的四大特性")]),t._v(" "),s("p",[t._v("原子性（Atomic）\n一致性（Consistency）\n隔离性（Isolation）\n持久性（Durability）")]),t._v(" "),s("p",[t._v("今天只聊隔离性，其他的比较好理解，建议看推荐阅读中关于事务的讲解。")]),t._v(" "),s("p",[t._v("先放一个表格，看看4个隔离级别会出现的各种问题，网上的解释一大堆。看完后还是一脸蒙蔽，感觉懂了，又好像没懂。因为没有具体的演示例子，索性自己尝试复现这几个问题，果然理解的清清楚楚。")]),t._v(" "),s("p",[t._v("√ 为会发生，×为不会发生")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("隔离级别")]),t._v(" "),s("th",[t._v("脏读")]),t._v(" "),s("th",[t._v("不可重复读")]),t._v(" "),s("th",[t._v("幻读")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("read uncommitted（未提交读）")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("√")])]),t._v(" "),s("tr",[s("td",[t._v("read committed（提交读）")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("√")])]),t._v(" "),s("tr",[s("td",[t._v("repeatable read（可重复读）")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("√")])]),t._v(" "),s("tr",[s("td",[t._v("serializable （可串行化）")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("×")])])])]),t._v(" "),s("p",[t._v("先看MySQL版本，5.5.61，下文的所有实验在这个版本上都能浮现")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("MySQL查看隔离级别")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@tx_isolation")]),t._v("\n")])])]),s("p",[t._v("MySQL在会话层面设置隔离级别")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("session")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("isolation")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("level")]),t._v(" 隔离级别\n")])])]),s("p",[t._v("开启事务")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),t._v("\n")])])]),s("p",[t._v("提交事务")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),t._v("\n")])])]),s("p",[t._v("回滚事务")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rollback")]),t._v("\n")])])]),s("p",[t._v("建立如下表")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("account"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AUTO_INCREMENT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("balance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'0'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRIMARY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("KEY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("InnoDB")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AUTO_INCREMENT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CHARSET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf8mb4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("用Navicat（其他工具也行）开2个查询的tab页，表示2个会话")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019030223151564.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("p",[t._v("在2个Tab页面分别执行如下语句")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@tx_isolation")]),t._v("\n")])])]),s("p",[t._v("输入都是REPEATABLE-READ，表明MySQL默认隔离级别为REPEATABLE-READ（可重复）读。")]),t._v(" "),s("h2",{attrs:{id:"脏读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#脏读"}},[t._v("#")]),t._v(" 脏读")]),t._v(" "),s("p",[t._v("表中的数据如下，设置隔离级别为未提交读")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303000017552.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("p",[t._v("按照时间在2个Tab页依次执行如下命令")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level read uncommitted;"),s("br"),t._v("start transaction;（开启事务）"),s("br"),t._v("update account set balance = balance + 1000 where id = 1;"),s("br"),t._v("select * from account where id = 1; "),s("br"),t._v("设置为未提交读，给张三账号+1000，输出为2000")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level read uncommitted;"),s("br"),t._v("start transaction;"),s("br"),t._v("select * from account where id = 1;"),s("br"),t._v("查询余额输出为2000")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("rollback")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T4")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("commit")])]),t._v(" "),s("tr",[s("td",[t._v("T5")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("select * from account where id = 1;"),s("br"),t._v("查询余额输出为1000")])])])]),t._v(" "),s("p",[t._v("举个例子概述一下这个过程，财务给张三发了1000元的工资，然后张三查询自己的账户，果然多了1000元，变成了2000元，结果财务操作过程有误，事务回滚。当张三再查账户时，却发现账户只有1000元。")]),t._v(" "),s("blockquote",[s("p",[t._v("脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。")])]),t._v(" "),s("p",[t._v("再举一个严重的例子，证明一下危害\n表中的数据如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303000017552.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level read uncommitted;"),s("br"),t._v("start transaction;"),s("br"),t._v("update account set balance = balance - 1000 where id = 1;"),s("br"),t._v("update account set balance = balance + 1000 where id = 2;"),s("br")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level read uncommitted;"),s("br"),t._v("start transaction;"),s("br"),t._v("select balance from account where id = 2;"),s("br"),t._v("update account set balance = balance - 1000 where id = 2;"),s("br"),t._v("更新语句被阻塞")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("rollback")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T4")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("commit")])])])]),t._v(" "),s("p",[t._v("执行完成，数据库中的数据如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303130605444.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("解释")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("1给2转1000")])]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td",[t._v("2的余额够1000元，购买1000元的东西，更新语句被阻塞")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("1回滚，1的余额变成1000，2的余额变成0")])]),t._v(" "),s("tr",[s("td",[t._v("T4")]),t._v(" "),s("td",[t._v("2成功扣款，余额0-1000=-1000")])])])]),t._v(" "),s("p",[t._v("现在好了，银行无缘无故损失1000元。")]),t._v(" "),s("h3",{attrs:{id:"不可重复读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不可重复读"}},[t._v("#")]),t._v(" 不可重复读")]),t._v(" "),s("p",[t._v("表中的数据如下，设置隔离级别为提交读")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303012127281.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level read committed;"),s("br"),t._v("start transaction;"),s("br"),t._v("select * from account where id = 2;"),s("br"),t._v(" 查询余额输出为0")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level read committed;"),s("br"),t._v("start transaction;"),s("br"),t._v("update account set balance = balance + 1000 where id = 2;"),s("br"),t._v("select * from account where id = 2;"),s("br"),t._v("commit;"),s("br"),t._v("查询余额输出1000")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("select * from account where id = 2; "),s("br"),t._v("commit;"),s("br"),t._v("查询余额输出1000")]),t._v(" "),s("td")])])]),t._v(" "),s("blockquote",[s("p",[t._v("不可重复读是指在事务1内，读取了一个数据，事务1还没有结束时，事务2也访问了这个数据，修改了这个数据，并提交。紧接着，事务1又读这个数据。由于事务2的修改，那么事务1两次读到的的数据可能是不一样的，因此称为是不可重复读。")])]),t._v(" "),s("p",[t._v("当然你可以在T2时间段客户端B修改完id=2的账户余额但没有commit的时候，在客户端A查询id=2的账户余额，发现账户余额为0，可以证明提交读这个隔离级别不会发生脏读。")]),t._v(" "),s("p",[t._v("现在用上面的例子看一下可重复读是个什么过程？\n表中的数据如下，设置隔离级别为可重复读")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303012127281.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v("select * from account where id = 2;"),s("br"),t._v(" 查询余额输出为0")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v("update account set balance = balance + 1000 where id = 2;"),s("br"),t._v("select * from account where id = 2;"),s("br"),t._v("commit;"),s("br"),t._v("查询余额输出1000")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("select * from account where id = 2; "),s("br"),t._v("commit;"),s("br"),t._v("查询余额输出0")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[t._v("仔细看这个例子和上面的例子在T3时间段的输出，理解了什么叫可重复读了吧？当我们将当前会话的隔离级别设置为可重复读的时候，当前会话可以重复读，就是每次读取的结果集都相同，而不管其他事务有没有提交。")]),t._v(" "),s("p",[t._v("但是在可重复读的隔离级别上，会产生幻读的问题。")]),t._v(" "),s("h3",{attrs:{id:"幻读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#幻读"}},[t._v("#")]),t._v(" 幻读")]),t._v(" "),s("p",[t._v("表中的数据如下，设置隔离级别为可重复读")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303012127281.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("p",[t._v("先上一段《高性能MySQL》对于幻读的解释")]),t._v(" "),s("blockquote",[s("p",[t._v("所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。InnoDB存储引擎通过多版本并发控制（MVCC）解决了幻读的问题。")])]),t._v(" "),s("p",[t._v("用大白话解释一下，就是事务1查询id<10的记录时，返回了2条记录，接着事务2插入了一条id为3的记录，并提交。接着事务1查询id<10的记录时，返回了3条记录，说好的可重复读呢？结果却多了一条数据。")]),t._v(" "),s("p",[t._v("MySQL通过MVCC解决了这种情况下的幻读，我们可以验证一下")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v("select count(*) from account where id <= 10;"),s("br"),t._v("输出2")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v('insert into account (id, name, balance) values (3, "王五", 0);'),s("br"),t._v("select count(*) from account where id <= 10;"),s("br"),t._v("commit;"),s("br"),t._v("输出3")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v("select count(*) from account where id <= 10;"),s("br"),t._v("commit;"),s("br"),t._v("输出2")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[t._v("这种情况下的幻读被解决了，我再举一个例子")]),t._v(" "),s("p",[t._v("表中的数据如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190303012127281.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("时间")]),t._v(" "),s("th",[t._v("客户端A（Tab A）")]),t._v(" "),s("th",[t._v("客户端B（Tab B）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("T1")]),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v("select count(*) from account where id = 3;"),s("br"),t._v("输出为0")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T2")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("set session transaction isolation level repeatable read;"),s("br"),t._v("start transaction;"),s("br"),t._v('insert into account (id, name, balance) values (3, "王五", 0);'),s("br"),t._v("commit;")])]),t._v(" "),s("tr",[s("td",[t._v("T3")]),t._v(" "),s("td",[t._v('insert into account (id, name, balance) values (3, "王五", 0);'),s("br"),t._v("主键重复，插入失败")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T4")]),t._v(" "),s("td",[t._v("select count(*) from account where id = 3;"),s("br"),t._v("输出为0")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("T5")]),t._v(" "),s("td",[t._v("rollback;")]),t._v(" "),s("td")])])]),t._v(" "),s("p",[t._v("select 某记录是否存在，不存在，准备插入此记录，但执行 insert 时发现此记录已存在，无法插入，这个就有问题了。")]),t._v(" "),s("p",[t._v("很多人容易搞混不可重复读和幻读，确实这两者有些相似。但"),s("strong",[t._v("不可重复读重点在于update和delete，而幻读的重点在于insert")]),t._v("。")]),t._v(" "),s("p",[t._v("总的来说幻读就是事务A对数据进行操作，事务B还是可以用insert插入数据的，因为使用的是行锁，这样导致的各种奇葩问题就是幻读。")]),t._v(" "),s("p",[t._v("当隔离级别设置为可串行化，强制事务串行执行，避免了前面说的幻读的问题。")])])}),[],!1,null,null,null);a.default=v.exports}}]);