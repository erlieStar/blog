(window.webpackJsonp=window.webpackJsonp||[]).push([[236],{634:function(s,t,a){"use strict";a.r(t);var e=a(56),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"rocketmq源码解析-如何快速查找消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rocketmq源码解析-如何快速查找消息"}},[s._v("#")]),s._v(" RocketMQ源码解析：如何快速查找消息？")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210428002900877.jpg?",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"消息查询介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消息查询介绍"}},[s._v("#")]),s._v(" 消息查询介绍")]),s._v(" "),a("p",[s._v("当我们使用MQ的时候，一个比较好的习惯就是把发送的消息和接收到的消息打印到日志中。当我们排查问题的时候就非常方便。")]),s._v(" "),a("p",[s._v("例如B服务需要消费A服务发送的关闭订单的消息。如果一个订单迟迟未关闭，此时可能有三种情况")]),s._v(" "),a("ol",[a("li",[s._v("A服务发送失败")]),s._v(" "),a("li",[s._v("B服务消费失败")]),s._v(" "),a("li",[s._v("B服务没有收到消息")])]),s._v(" "),a("p",[s._v("A服务发送失败可以通过日志快速确认。")]),s._v(" "),a("p",[s._v("如果A服务发送成功，此时就可能根据消息的属性快速查找到具体的消息，看这条消息是否被对应的ConsumerGroup消费过，如果没消费此时说明B服务之类的配置可能有问题，导致没有收到消息。如果被消费过说明B服务消费的逻辑可能有问题，查看对应的日志排查即可，问题修复后，可以通过命令或者管控台重新发送消息即可。")]),s._v(" "),a("p",[a("strong",[s._v("那么查找指定消息的方式有几种呢？")])]),s._v(" "),a("p",[s._v("前面我们说过，RocketMQ中用QueryMessageProcessor来处理消息查找的请求\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/e19f2031e72b40a387941b540ae16b35.png?",alt:"在这里插入图片描述"}}),s._v("\n可以看到有两种处理方式")]),s._v(" "),a("ol",[a("li",[s._v("QueryMessageProcessor#queryMessage，根据Unique Key和 Message Key查询")]),s._v(" "),a("li",[s._v("QueryMessageProcessor#viewMessageById，根据Message Id查询")])]),s._v(" "),a("p",[a("strong",[s._v("Unique Key，Message Key，Message Id又是怎么来的？")])]),s._v(" "),a("p",[s._v("Unique Key是在producer端发送消息生成的")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DefaultMQProducerImpl#sendKernelImpl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("instanceof")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageBatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageClientIDSetter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUniqID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[a("strong",[s._v("Message Key是我们在发送消息的时候设置的哈，通常具有业务意义，方便我们快速查找消息")])]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定 topicName，tagName，MessageKey，消息内容，然后发送消息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" messageKey "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" UUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("randomUUID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TOPIC_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TAG_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" messageKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello rocketmq "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBytes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DEFAULT_CHARSET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SendResult")]),s._v(" sendResult "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" producer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sendResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("Message Id是在broker端生成的，当将消息写入内存后，返回结果中会设置Message Id（主要内容就是broker的地址和消息写入的偏移量）")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DefaultAppendMessageCallback#doAppend")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Supplier")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" msgIdSupplier "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sysflag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" msgInner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSysFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" msgIdLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysflag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageSysFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("STOREHOSTADDRESS_V6_FLAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ByteBuffer")]),s._v(" msgIdBuffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ByteBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("allocate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msgIdLen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageExt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("socketAddress2ByteBuffer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msgInner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getStoreHost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msgIdBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    msgIdBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("clear")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//because socketAddress2ByteBuffer flip the buffer")]),s._v("\n    msgIdBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("putLong")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msgIdLen "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wroteOffset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UtilAll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bytes2string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msgIdBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("array")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("跑个Demo演示一下")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定 topicName 和消息内容，然后发送消息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TOPIC_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello rocketmq "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getBytes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RemotingHelper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DEFAULT_CHARSET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SendResult")]),s._v(" sendResult "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" producer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sendResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SendResult")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sendStatus"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("SEND_OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nmsgId"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("C0A86130AD2D18B4AAC22CAD6B000000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\noffsetMsgId"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31E8336700002")]),s._v("A9F00000000000A1AAA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nmessageQueue"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageQueue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("quickStartTopic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" brokerName"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("broker"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queueId"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queueOffset"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("p",[s._v("sendStatus：发送状态\nmsgId：虽然命名为msgId，实际是Unique Key\noffsetMsgId：Broker返回的Message ID\nmessageQueue：消息发送到哪个队列\nqueueOffset：消息在队列中的偏移量")]),s._v(" "),a("p",[s._v("此时我们根据msgId和offsetMsgId都能在管控台的MESSAGE ID tab页查找到对应的消息\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210509162138194.png?",alt:"在这里插入图片描述"}}),s._v("\n也可以根据指定的messageKey在管控台的MESSAGE KEY tab页查找到对应的消息")]),s._v(" "),a("p",[a("strong",[s._v("消息查询可以通过命令行和管控台实现。一般情况下用管控台足够了")])]),s._v(" "),a("h2",{attrs:{id:"按照message-id查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#按照message-id查询"}},[s._v("#")]),s._v(" 按照Message Id查询")]),s._v(" "),a("p",[s._v("通过Message Id查询时客户端会调用到如下方法")]),s._v(" "),a("p",[s._v("org.apache.rocketmq.client.impl.MQAdminImpl#viewMessage\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/990c627959eb49f8991f0fd83672cb8d.png?",alt:"在这里插入图片描述"}}),s._v("\n根据Message Id查找消息的逻辑非常简单，从Message Id中解析出broker的地址和消息的偏移量，发送查找请求（查找请求包含消息的偏移量）到broker，broker收到请求后到commitLog根据消息的偏移量查找到对应的消息返回即可。")]),s._v(" "),a("p",[s._v("调用链路如下")]),s._v(" "),a("ol",[a("li",[s._v("org.apache.rocketmq.client.impl.MQAdminImpl#viewMessage")]),s._v(" "),a("li",[s._v("org.apache.rocketmq.broker.processor.QueryMessageProcessor#viewMessageById")]),s._v(" "),a("li",[s._v("org.apache.rocketmq.store.DefaultMessageStore#selectOneMessageByOffset(long)")])]),s._v(" "),a("h2",{attrs:{id:"根据unique-key和-message-key查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#根据unique-key和-message-key查询"}},[s._v("#")]),s._v(" 根据Unique Key和 Message Key查询")]),s._v(" "),a("p",[s._v("通过Message Id查询时客户端会调用到如下方法")]),s._v(" "),a("p",[s._v("org.apache.rocketmq.client.impl.MQAdminImpl#queryMessage(java.lang.String, java.lang.String, int, long, long, boolean)")]),s._v(" "),a("p",[s._v("最终会调用到如下方法\norg.apache.rocketmq.store.index.IndexFile#selectPhyOffset")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/1d8e3c9841d745468417fc613602444e.png?",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("前面章节说过IndexFile本质上可以理解为一个大的HashMap，其中的key有两种形式")]),s._v(" "),a("ol",[a("li",[s._v("Topic#Unique Key")]),s._v(" "),a("li",[s._v("Topic#Message Key")])]),s._v(" "),a("p",[s._v("当根据Unique Key和Message Key查找消息时，求出对应key的hash值，然后将这个hash值对应的所有的消息从IndexFile中查找出来，接着根据phyoffset从CommitLog中找到消息具体的内容，然后返回")]),s._v(" "),a("p",[a("strong",[s._v("按照这种形式返回的消息有问题吗？")])]),s._v(" "),a("p",[s._v("其实是有问题的，因为hash值相同，并不代表消息的Unique Key或Message Key相同，所以此时还需要在客户端根据具体的值再过滤一遍，源码如下")]),s._v(" "),a("p",[s._v("org.apache.rocketmq.client.impl.MQAdminImpl#queryMessage(java.lang.String, java.lang.String, int, long, long, boolean)\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/520b3d6ec60c4a1dadc883abb2750319.png?",alt:"在这里插入图片描述"}}),s._v("\n如果是Unique Key，则直接判等。如果是Message Key，因为一个消息可以设置多个Message Key，所以只要有匹配则会将消息返回")]),s._v(" "),a("p",[s._v("追一下调用链路大概就全懂了")]),s._v(" "),a("ol",[a("li",[s._v("org.apache.rocketmq.client.impl.MQAdminImpl#queryMessage(java.lang.String, java.lang.String, int, long, long, boolean)")]),s._v(" "),a("li",[s._v("org.apache.rocketmq.broker.processor.QueryMessageProcessor#queryMessage")]),s._v(" "),a("li",[s._v("org.apache.rocketmq.store.index.IndexFile#selectPhyOffset")])])])}),[],!1,null,null,null);t.default=n.exports}}]);