(window.webpackJsonp=window.webpackJsonp||[]).push([[185],{582:function(s,t,a){"use strict";a.r(t);var n=a(56),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mybatis源码解析-mybatis如何和spring进行整合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mybatis源码解析-mybatis如何和spring进行整合"}},[s._v("#")]),s._v(" Mybatis源码解析：Mybatis如何和Spring进行整合？")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/ccdc187697c7412a9ec67d8040ff089f.jpg?",alt:"请添加图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"mybatis整合spring比较重要的几个类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mybatis整合spring比较重要的几个类"}},[s._v("#")]),s._v(" Mybatis整合Spring比较重要的几个类")]),s._v(" "),a("p",[s._v("当我们整合spring和mybatis的时候，只需要在pom文件中增加如下依赖即可")]),s._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.mybatis"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("mybatis-spring"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1.3.1"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])])]),a("p",[s._v("然后增加一个配置类，手动注入SqlSessionTemplate和SqlSessionFactory即可，然后用@MapperScan指定mapper类所在的包名")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@MapperScan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"com.javashitang.blog.dao"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MybatisConfig")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DataSource")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DruidDataSource")]),s._v(" ds "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DruidDataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setDriverClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"com.mysql.jdbc.Driver"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUrl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"jdbc:mysql://myhost:3306/test?characterEncoding=utf8&useSSL=true"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setUsername")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setPassword")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionTemplate")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sqlSessionTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionFactory")]),s._v(" sqlSessionFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionTemplate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sqlSessionFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionFactory")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sqlSessionFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionFactoryBean")]),s._v(" sessionFactory "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionFactoryBean")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        sessionFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setDataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dataSource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        sessionFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMapperLocations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PathMatchingResourcePatternResolver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"classpath:mappers/*.xml"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" sessionFactory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getObject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("这几个类是如何整合的呢？我们来分析一下")]),s._v(" "),a("h3",{attrs:{id:"sqlsessionfactorybean"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sqlsessionfactorybean"}},[s._v("#")]),s._v(" SqlSessionFactoryBean")]),s._v(" "),a("p",[s._v("单独使用mybatis时，SqlSessionFactoryBuilder会通过解析mybatis-config.xml，mapper.xml文件的内容，得到Configuration对象，然后创建SqlSessionFactory对象。")]),s._v(" "),a("p",[s._v("mybatis整合spring后，SqlSessionFactoryBean从application.yaml配置文件中加载mybatis相关的配置，并创建SqlSessionFactory对象")]),s._v(" "),a("h3",{attrs:{id:"sqlsessiontemplate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sqlsessiontemplate"}},[s._v("#")]),s._v(" SqlSessionTemplate")]),s._v(" "),a("p",[s._v("单独使用mybatis的时候，我们可以使用DefaultSqlSession或者SqlSessionManager来执行sql，当和spring集成时我们用SqlSessionTemplate来执行sql")]),s._v(" "),a("p",[s._v("DefaultSqlSession是线程不安全的，即DefaultSqlSession不能是单例的\n而SqlSessionTemplate是线程安全的，那它是如何保证线程的呢？")]),s._v(" "),a("p",[s._v("SqlSessionTemplate执行sql的时候会交给sqlSessionProxy这个代理类来执行")]),s._v(" "),a("p",[s._v("SqlSessionTemplate#selectOne\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/33abf8b473fa4285bd5030ddde118725.png?",alt:"在这里插入图片描述"}}),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/64605af381794154a901d04cceb6c8a7.png?",alt:"在这里插入图片描述"}}),s._v("\n所以当通过SqlSessionTemplate执行方法时，会调用到SqlSessionInterceptor#invoke方法\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/64d57bb6b3644f8187284f3e5746ec1c.png?",alt:"在这里插入图片描述"}}),s._v("\n执行过程也比较清晰，首先获取sqlSession，然后调用sqlSession的方法，最后关闭sqlSession")]),s._v(" "),a("p",[s._v("获取sqlSession分为如下2种情况")]),s._v(" "),a("ol",[a("li",[s._v("如果要执行的方法不在事务中，则每次创建新的SqlSession")]),s._v(" "),a("li",[s._v("如果要执行的方法在事务中，则会先从TransactionSynchronizationManager中获取（如果没有的话，先创建SqlSession，然后放到TransactionSynchronizationManager中，你可以把TransactionSynchronizationManager类比为ThreadLocal），这样就能保证一个事务中用到的SqlSession是同一个")])]),s._v(" "),a("p",[s._v("因此当mybatis和spring整合的时候，如果没有事务，一级缓存会失效，如果有事务，一级缓存不会失效\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/72b49cf86fc741e7952b582a883abc20.png?",alt:"在这里插入图片描述"}}),s._v("\n当执行完成，关闭sqlSession的时候")]),s._v(" "),a("p",[s._v("如果sqlSession在事务中，只会减少引用的数量，并不会关闭sqlSession，当事务都执行完毕才会关闭sqlSession\n如果sqlSession不在事务中，则会关闭sqlSession")]),s._v(" "),a("h3",{attrs:{id:"mapperscan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mapperscan"}},[s._v("#")]),s._v(" @MapperScan")]),s._v(" "),a("p",[s._v("当我们不使用@MapperScan注解的时候，需要手动往容器中注入mapper实现类")]),s._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlogUserMapper")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("blogUserMapper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SqlSessionTemplate")]),s._v(" sqlSessionTemplate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" sqlSessionTemplate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMapper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BlogUserMapper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("当用了@MapperScan注解后，就可以指定包名，然后自动注入，每个mapper接口的实现类会被封装为MapperFactoryBean类")]),s._v(" "),a("h3",{attrs:{id:"mapperfactorybean"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mapperfactorybean"}},[s._v("#")]),s._v(" MapperFactoryBean")]),s._v(" "),a("p",[s._v("MapperFactoryBean实现了FactoryBean接口，所以会调用getObject方法获取工厂生产的对象，可以看到和我们手动注入的方式没什么差别")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/6a4f6eac08644db48f28b3424094ebaa.png",alt:"在这里插入图片描述"}})])])}),[],!1,null,null,null);t.default=e.exports}}]);