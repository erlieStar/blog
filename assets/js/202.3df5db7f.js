(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{601:function(s,t,a){"use strict";a.r(t);var n=a(56),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql实战-order-by-语句怎么优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql实战-order-by-语句怎么优化"}},[s._v("#")]),s._v(" MySQL实战：order by 语句怎么优化？")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/f28146cc48de4106804d9282cf172851.png",alt:"请添加图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"order-by是怎么工作的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#order-by是怎么工作的"}},[s._v("#")]),s._v(" order by是怎么工作的？")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("person"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("age"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("假如有如上一张表执行如下sql")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("explain")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" age "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" person "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" city "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'杭州'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("order")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[s._v("explain的结果如下")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/d9d0159d52804bc6ad6bd159af02f8ca.png#pic_center",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("Extra列中有Using filesort说明进行了排序，"),a("strong",[s._v("排序这个动作有可能在内存中完成，也有可能在磁盘中完成")])]),s._v(" "),a("p",[s._v("那么对记录根据name字段排序是如何做到的呢？")]),s._v(" "),a("p",[a("strong",[s._v("排序的方式主要分为两种，全字段排序和rowid排序")])]),s._v(" "),a("h2",{attrs:{id:"全字段排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全字段排序"}},[s._v("#")]),s._v(" 全字段排序")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/3576b563035d4118b667d4538e526d33.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("全字段排序的过程如下")]),s._v(" "),a("ol",[a("li",[s._v("初始化 sort buffer，从 city 索引找满足city=杭州条件的主键id")]),s._v(" "),a("li",[s._v("根据主键id回表找到对应的记录，取出 name city age 三个字段的值，存入 sort buffer")]),s._v(" "),a("li",[s._v("从 city 索引找到下一个记录的主键")]),s._v(" "),a("li",[s._v("重复步骤2，3，找到所有满足条件的记录")]),s._v(" "),a("li",[s._v("对 sort buffer 中的数据按照字段 name 排序，排序结果取前1000行返回客户端")])]),s._v(" "),a("p",[s._v("我们可以通过执行如下语句查看sort buffer的大小")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%sort_buffer%'")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/aca5f980d53c4dffaf7dfc6ad414a638.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("我们把这个排序的过程叫做全字段排序")])]),s._v(" "),a("p",[s._v("按name排序这个动作，可能在内存中完成，也可能需要使用外部排序。这取决于排序需要的内存大小和 sort_buffer_size（mysql为排序开辟的内存大小，即sort buffer）")]),s._v(" "),a("p",[s._v("如果数据量太大，则需要利用磁盘文件排序")]),s._v(" "),a("h2",{attrs:{id:"rowid排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rowid排序"}},[s._v("#")]),s._v(" rowid排序")]),s._v(" "),a("p",[s._v("如果查询要返回的字段很多的话，那么sort buffer里面需要放的字段数也很多，此时就会分成很多临时文件，排序的性能会很差")]),s._v(" "),a("p",[s._v("如果单行很大，这个方法效率不够好。那我们减少放入sort buffer的大小不就能解决这个问题吗？")]),s._v(" "),a("p",[s._v("当单行的大小超过定值时，我们只往sort buffer放入必要的字段（主键id和排序的字段），等按照name排好序后，根据主键id回表查询数据返回即可")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/b66749f9fa6c424481f6ebd53b2417f7.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[a("strong",[s._v("我们把这个排序的过程叫做rowid排序")])]),s._v(" "),a("p",[s._v("我们可以通过执行如下语句设置一个定值，当单行的大小超过这个定值时，让mysql换一个算法")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" max_length_for_sort_data "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[a("strong",[s._v("全字段排序，rowid排序如何选择？")])]),s._v(" "),a("p",[a("strong",[s._v("当内存足够的时候会采用全字段排序，减少磁盘访问。当内存不够的时候才会采用rowid排序")])]),s._v(" "),a("p",[s._v("当然并不是所有的 order by 语句，都是需要排序操作的。MySQL之所以要生成临时表，并在临时表上做排序操作，其原因是原来的数据都是无序的")]),s._v(" "),a("p",[a("strong",[s._v("有没有可能取数据的时候，name就已经是有序的？")])]),s._v(" "),a("p",[s._v("我们建一个 city 和 name 的联合索引不就满足了")]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" person "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" city_user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/657139ed1c88458fa03969b3fe433e0b.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("可以看到执行计划的Extra列已经没有 Using filesort 了，说明不用排序，因为从索引上读取数据时，name已经有序了")]),s._v(" "),a("p",[a("strong",[s._v("假设现在person表对 city 和 name 建了联合索引，那么下面语句需要排序吗？")])]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("explain")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" person "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" city "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'杭州'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("order")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/f07f5f9b4d53413e9b70bd40fc4150ea.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("答案是不会，一个城市的name是有序的，不用排序")]),s._v(" "),a("p",[a("strong",[s._v("如果是下面的语句呢？")])]),s._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("explain")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" person "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" city "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'杭州'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'苏州'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("order")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("by")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("limit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/467ba32e5c824e358c0a907e828bdfda.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("答案是会，多个城市的name不是有序的，需要排序")]),s._v(" "),a("p",[a("strong",[s._v("当 order by 语句执行的比较慢时，我们可以通过如下方法来进行优化")])]),s._v(" "),a("ol",[a("li",[s._v("排序的字段增加索引")]),s._v(" "),a("li",[s._v("增大 sort buffer 的大小")]),s._v(" "),a("li",[s._v("不要用 * 作为查询列表，只返回需要的列")])])])}),[],!1,null,null,null);t.default=r.exports}}]);